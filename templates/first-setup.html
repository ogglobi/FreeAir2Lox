<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeAir2Lox-Bridge - Erstes Setup</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #1a1d26;
            color: #f0f6fc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .setup-container {
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .setup-header {
            background: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            border-bottom: 1px solid #30363d;
            padding: 50px 40px;
            text-align: center;
        }

        .setup-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: #7FB619;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .setup-header p {
            font-size: 1rem;
            color: #8b949e;
            font-weight: 400;
        }

        .setup-body {
            padding: 40px;
        }

        .setup-step {
            margin-bottom: 40px;
        }

        .step-title {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #7FB619;
        }

        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: #7FB619;
            color: white;
            border-radius: 50%;
            font-weight: 700;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .setup-step hr {
            border: none;
            border-top: 1px solid #30363d;
            margin: 40px 0;
        }

        .form-label {
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-control {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #f0f6fc;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-control::placeholder {
            color: #6e7681;
        }

        .form-control:focus {
            border-color: #7FB619;
            outline: none;
            box-shadow: 0 0 0 3px rgba(127, 182, 25, 0.1);
            background-color: #0d1117;
        }

        .form-text {
            color: #8b949e;
            font-size: 0.85rem;
            margin-top: 4px;
        }

        .device-card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .device-card:hover {
            border-color: #7FB619;
            box-shadow: 0 0 0 1px rgba(127, 182, 25, 0.1);
        }

        .device-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
        }

        .device-card-title {
            font-weight: 600;
            color: #f0f6fc;
            font-size: 1rem;
        }

        .device-card small {
            color: #8b949e;
            font-size: 0.85rem;
        }

        .btn-remove-device {
            background-color: #da3633;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-remove-device:hover {
            background-color: #f85149;
        }

        .btn-add-device {
            background-color: #7FB619;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .btn-add-device:hover {
            background-color: #5A9200;
        }

        .devices-list {
            max-height: 320px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 0;
            background-color: #0d1117;
        }

        .devices-list > .device-card {
            border: none;
            border-bottom: 1px solid #30363d;
            border-radius: 0;
            margin-bottom: 0;
        }

        .devices-list > .device-card:last-child {
            border-bottom: none;
        }

        .setup-footer {
            padding: 30px 40px;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid #30363d;
            background-color: #0d1117;
        }

        .btn-setup {
            padding: 10px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: 6px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-start {
            background-color: #7FB619;
            color: white;
            border-color: #7FB619;
        }

        .btn-start:hover {
            background-color: #5A9200;
            border-color: #5A9200;
        }

        .btn-start:disabled {
            background-color: #6e7681;
            border-color: #6e7681;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-skip {
            background-color: transparent;
            color: #8b949e;
            border-color: #30363d;
        }

        .btn-skip:hover {
            background-color: #161b22;
            border-color: #7FB619;
            color: #7FB619;
        }

        .alert {
            border-radius: 6px;
            border: 1px solid;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 0.95rem;
        }

        .alert-info {
            background-color: rgba(127, 182, 25, 0.1);
            border-color: #7FB619;
            color: #79c0ff;
        }

        .alert-success {
            background-color: rgba(63, 185, 80, 0.1);
            border-color: #3fb950;
            color: #56d364;
        }

        .alert-warning {
            background-color: rgba(210, 153, 34, 0.1);
            border-color: #d29922;
            color: #d29922;
        }

        .alert-danger {
            background-color: rgba(248, 81, 73, 0.1);
            border-color: #f85149;
            color: #ff7b72;
        }

        .alert-dismissible .btn-close {
            background: none;
            border: none;
            color: #8b949e;
            opacity: 1;
            cursor: pointer;
            padding: 0;
            font-size: 1.2rem;
        }

        .alert-dismissible .btn-close:hover {
            color: #f0f6fc;
        }

        .empty-state {
            text-align: center;
            color: #6e7681;
            padding: 20px;
            font-style: italic;
            font-size: 0.95rem;
        }

        .loader {
            display: none;
            text-align: center;
            padding: 0;
            color: #7FB619;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #30363d;
            border-top-color: #7FB619;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .device-form-container {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 24px;
            margin-top: 20px;
        }

        .device-form-container h5 {
            color: #7FB619;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .col-md-6 {
            flex: 1;
            min-width: 200px;
        }

        .col-md-8 {
            flex: 1;
            min-width: 250px;
        }

        .col-md-4 {
            flex: 0 0 auto;
            min-width: 120px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 0;
        }

        .btn-save {
            background-color: #7FB619;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .btn-save:hover {
            background-color: #5A9200;
        }

        .btn-cancel {
            background-color: #21262d;
            color: #8b949e;
            border: 1px solid #30363d;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background-color: #30363d;
            border-color: #7FB619;
            color: #7FB619;
        }

        p.text-muted {
            color: #8b949e;
            font-size: 0.95rem;
        }

        /* Scrollbar styling */
        .devices-list::-webkit-scrollbar {
            width: 8px;
        }

        .devices-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .devices-list::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        .devices-list::-webkit-scrollbar-thumb:hover {
            background: #424b57;
        }

        @media (max-width: 768px) {
            .setup-header {
                padding: 30px 20px;
            }

            .setup-body {
                padding: 20px;
            }

            .setup-footer {
                padding: 20px;
                flex-wrap: wrap;
            }

            .setup-header h1 {
                font-size: 1.8rem;
            }

            .step-title {
                font-size: 1.1rem;
            }

            .row {
                flex-direction: column;
            }

            .col-md-6, .col-md-8, .col-md-4 {
                width: 100%;
                min-width: auto;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-setup {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-header">
            <h1><i class="bi bi-gear-fill"></i> FreeAir2Lox-Bridge</h1>
            <p>Erstes Setup - Konfigurieren Sie Ihre Geräte und den Loxone Miniserver</p>
        </div>

        <div class="setup-body">
            <div id="alertContainer"></div>

            <!-- STEP 0: Admin Password Setup -->
            <div class="setup-step">
                <div class="step-title">
                    <div class="step-number">0</div>
                    <div>Admin-Passwort setzen</div>
                </div>

                <div style="background-color: #ffebee; border-left: 4px solid #f44336; padding: 15px; border-radius: 4px; margin-bottom: 25px; color: #c62828;">
                    <strong style="font-size: 1.1rem; display: block; margin-bottom: 8px;">⚠️ WICHTIG!</strong>
                    Notieren Sie sich dieses Passwort gründlich.<br/>
                    <strong>Ohne dieses Passwort können Sie sich später NICHT mehr anmelden!</strong>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="adminPassword" class="form-label">Admin-Passwort</label>
                        <input type="password" class="form-control" id="adminPassword" placeholder="Mindestens 4 Zeichen" autocomplete="off" minlength="4" required>
                        <div class="form-text">Mindestens 4 Zeichen empfohlen</div>
                    </div>
                    <div class="col-md-6">
                        <label for="adminPasswordConfirm" class="form-label">Passwort wiederholen</label>
                        <input type="password" class="form-control" id="adminPasswordConfirm" placeholder="Passwort erneut eingeben" autocomplete="off" minlength="4" required>
                        <div class="form-text">Muss identisch mit dem obigen Passwort sein</div>
                    </div>
                </div>
            </div>

            <div class="setup-step" style="margin-bottom: 0; margin-top: 0;">
                <hr>
            </div>

            <!-- STEP 1: Loxone Configuration -->
            <div class="setup-step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    <div>Loxone Miniserver Konfiguration</div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <label for="loxoneIp" class="form-label">Loxone Miniserver IP-Adresse</label>
                        <input type="text" class="form-control" id="loxoneIp" placeholder="z.B. 192.168.1.50" value="192.168.1.50">
                        <div class="form-text">Die IP-Adresse Ihres Loxone Miniservers im Netzwerk</div>
                    </div>
                    <div class="col-md-4">
                        <label for="loxonePort" class="form-label">UDP Port</label>
                        <input type="number" class="form-control" id="loxonePort" placeholder="5555" value="5555">
                        <div class="form-text">Standard: 5555</div>
                    </div>
                </div>
            </div>

            <div class="setup-step" style="margin-bottom: 0; margin-top: 0;">
                <hr>
            </div>

            <!-- STEP 2: FreeAir Devices -->
            <div class="setup-step">
                <div class="step-title">
                    <div class="step-number">2</div>
                    <div>FreeAir Geräte hinzufügen (optional)</div>
                </div>

                <p class="text-muted">Sie können jetzt Ihre FreeAir Geräte hinzufügen oder dies später über das Dashboard machen.</p>

                <button type="button" class="btn-add-device" onclick="addDeviceRow()">
                    <i class="bi bi-plus-circle"></i> Gerät hinzufügen
                </button>

                <div id="devicesList" class="devices-list">
                    <div class="empty-state">Noch keine Geräte hinzugefügt</div>
                </div>
            </div>

            <!-- Device Form (initially hidden) -->
            <div id="deviceFormContainer" style="display: none;" class="device-form-container">
                <h5><i class="bi bi-device-ssd"></i> Neues Gerät hinzufügen</h5>

                <div class="row">
                    <div class="col-md-6">
                        <label for="deviceName" class="form-label">Gerätename</label>
                        <input type="text" class="form-control" id="deviceName" placeholder="z.B. Wohnzimmer">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="serialNo" class="form-label">Seriennummer</label>
                        <input type="text" class="form-control" id="serialNo" placeholder="z.B. FA100001">
                    </div>
                    <div class="col-md-6">
                        <label for="devicePassword" class="form-label">Passwort</label>
                        <input type="password" class="form-control" id="devicePassword" placeholder="Gerätepasswort">
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn-save" onclick="saveDevice()">
                        <i class="bi bi-check-circle"></i> Gerät speichern
                    </button>
                    <button type="button" class="btn-cancel" onclick="cancelDeviceForm()">
                        <i class="bi bi-x-circle"></i> Abbrechen
                    </button>
                </div>
            </div>
        </div>

        <div class="setup-footer">
            <div class="loader" id="loader">
                <div class="spinner"></div>
                <span style="margin-left: 10px;">Speichern...</span>
            </div>
            <button type="button" class="btn-setup btn-start" id="setupCompleteBtn" onclick="completeSetup()">
                <i class="bi bi-check-lg"></i> Setup abschließen
            </button>
            <button type="button" class="btn-setup btn-skip" onclick="skipSetup()">
                <i class="bi bi-skip-forward"></i> Überspringen
            </button>
        </div>
    </div>

    <script>
        let devices = [];
        let deviceFormOpen = false;

        function showAlert(message, type = 'info') {
            const alertId = 'alert-' + Date.now();
            let iconClass = 'bi-info-circle';
            if (type === 'success') iconClass = 'bi-check-circle-fill';
            if (type === 'warning') iconClass = 'bi-exclamation-triangle-fill';
            if (type === 'danger') iconClass = 'bi-x-circle-fill';

            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible" role="alert" id="${alertId}">
                    <i class="bi ${iconClass}" style="margin-right: 8px;"></i>
                    ${message}
                    <button type="button" class="btn-close" onclick="document.getElementById('${alertId}').remove()"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML += alertHtml;
            setTimeout(() => {
                const elem = document.getElementById(alertId);
                if (elem) elem.remove();
            }, 5000);
        }

        function addDeviceRow() {
            deviceFormOpen = true;
            document.getElementById('deviceFormContainer').style.display = 'block';
            document.getElementById('deviceName').focus();
        }

        function cancelDeviceForm() {
            deviceFormOpen = false;
            document.getElementById('deviceFormContainer').style.display = 'none';
            document.getElementById('deviceName').value = '';
            document.getElementById('serialNo').value = '';
            document.getElementById('devicePassword').value = '';
        }

        function saveDevice() {
            const name = document.getElementById('deviceName').value.trim();
            const serialNo = document.getElementById('serialNo').value.trim();
            const password = document.getElementById('devicePassword').value.trim();

            if (!name) {
                showAlert('Bitte geben Sie einen Gerätenamen ein', 'warning');
                return;
            }
            if (!serialNo) {
                showAlert('Bitte geben Sie die Seriennummer ein', 'warning');
                return;
            }
            if (!password) {
                showAlert('Bitte geben Sie das Passwort ein', 'warning');
                return;
            }

            // Auto-generate ID from name (e.g., "Wohnzimmer" → "freeair-wohnzimmer")
            const id = 'freeair-' + name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

            // Check for duplicate ID
            if (devices.some(d => d.id === id)) {
                showAlert('Ein Gerät mit dem Namen "' + name + '" existiert bereits', 'warning');
                return;
            }

            devices.push({
                id: id,
                name: name,
                serial_no: serialNo,
                password: password,
                enabled: true
            });

            cancelDeviceForm();
            renderDevices();
            showAlert('Gerät "' + name + '" hinzugefügt!', 'success');
        }

        function removeDevice(id) {
            devices = devices.filter(d => d.id !== id);
            renderDevices();
            showAlert('Gerät entfernt', 'info');
        }

        function renderDevices() {
            const container = document.getElementById('devicesList');

            if (devices.length === 0) {
                container.innerHTML = '<div class="empty-state">Noch keine Geräte hinzugefügt</div>';
                return;
            }

            let html = '';
            devices.forEach(device => {
                html += `
                    <div class="device-card">
                        <div class="device-card-header">
                            <div>
                                <div class="device-card-title">${device.name}</div>
                                <small>S/N: ${device.serial_no}</small>
                            </div>
                            <button type="button" class="btn-remove-device" onclick="removeDevice('${device.id}')">
                                <i class="bi bi-trash"></i> Entfernen
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function completeSetup() {
            // Validate password
            const adminPassword = document.getElementById('adminPassword').value.trim();
            const adminPasswordConfirm = document.getElementById('adminPasswordConfirm').value.trim();

            if (!adminPassword || !adminPasswordConfirm) {
                showAlert('Bitte geben Sie ein Admin-Passwort ein', 'warning');
                return;
            }

            if (adminPassword.length < 4) {
                showAlert('Das Passwort muss mindestens 4 Zeichen lang sein', 'warning');
                return;
            }

            if (adminPassword !== adminPasswordConfirm) {
                showAlert('Die Passwörter stimmen nicht überein!', 'warning');
                return;
            }

            const loxoneIp = document.getElementById('loxoneIp').value.trim();
            const loxonePort = document.getElementById('loxonePort').value.trim();

            if (!loxoneIp) {
                showAlert('Bitte geben Sie die Loxone IP-Adresse ein', 'warning');
                return;
            }

            if (!loxonePort || isNaN(loxonePort)) {
                showAlert('Bitte geben Sie einen gültigen Port ein', 'warning');
                return;
            }

            document.getElementById('loader').style.display = 'flex';
            document.getElementById('setupCompleteBtn').disabled = true;

            try {
                // Set admin password first
                const passwordResponse = await fetch('/api/setup-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: adminPassword,
                        confirm_password: adminPasswordConfirm
                    })
                });

                if (!passwordResponse.ok) {
                    throw new Error('Fehler beim Speichern des Admin-Passworts');
                }

                // Save Loxone config
                const loxoneResponse = await fetch('/api/loxone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip: loxoneIp,
                        port: parseInt(loxonePort),
                        enabled: true
                    })
                });

                if (!loxoneResponse.ok) {
                    throw new Error('Fehler beim Speichern der Loxone-Konfiguration');
                }

                // Add all devices
                for (const device of devices) {
                    const deviceResponse = await fetch('/api/devices', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(device)
                    });

                    if (!deviceResponse.ok) {
                        throw new Error(`Fehler beim Hinzufügen des Geräts: ${device.name}`);
                    }
                }

                // Mark setup as complete
                await fetch('/api/setup-complete', { method: 'POST' });

                showAlert('Setup erfolgreich abgeschlossen! Weiterleitung zum Dashboard...', 'success');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);

            } catch (error) {
                console.error('Setup error:', error);
                showAlert('Fehler: ' + error.message, 'danger');
            } finally {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('setupCompleteBtn').disabled = false;
            }
        }

        function skipSetup() {
            if (confirm('Möchten Sie das Setup wirklich überspringen? Sie können es später über das Dashboard abschließen.')) {
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>
